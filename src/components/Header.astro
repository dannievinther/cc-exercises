---
import { getCollection } from "astro:content";
import AboutPopup from "./AboutPopup.astro";
import BrowserAlert from "./BrowserAlert.astro";
import Logo from "./Logo.astro";
import NavItem from "./NavItem.astro";
import ViewToggle from "./ViewToggle.astro";
import { navItems, isCurrentPath, type Exercise } from "../data/navigation";

const { hasWarning, title } = Astro.props;

// Find current collection based on pathname
const currentItem = navItems.find((item) =>
  isCurrentPath(Astro.url.pathname, item.href)
);

// Fetch exercises for current collection
let exercises: Exercise[] = [];
if (currentItem) {
  const isStaging = process.env.VERCEL_GIT_COMMIT_REF === "staging";
  const showDrafts = import.meta.env.DEV || isStaging;

  const allExercises = (await getCollection(
    currentItem.collection as any
  )) as Exercise[];
  exercises = allExercises
    .filter((entry: Exercise) => showDrafts || !entry.data.draft)
    .sort((a: Exercise, b: Exercise) =>
      a.id.localeCompare(b.id, undefined, { numeric: true })
    );
}

const isSingleView =
  Astro.url.pathname.replace(/\/$/, "").match(/\/\d+$/) !== null;
const baseHref = currentItem?.href || "/grid";
const singleHref = baseHref.replace(/\/$/, "") + "/1";
---

<header class="main-header">
  <div class="header-content">
    <Logo />
    <nav>
      <ul>
        {
          navItems.map((item, i) => (
            <NavItem {item} index={i} {exercises} {currentItem} />
          ))
        }
      </ul>
    </nav>
    <div class="utils">
      <AboutPopup class="about-button" />
      <ViewToggle {isSingleView} {baseHref} {singleHref} />
    </div>
  </div>
</header>

<BrowserAlert />

<style>
  nav {
    anchor-name: --nav;
    position-anchor: --header;
    position: fixed;
    inset-inline-start: 0;
    inset-inline-end: 0;
    inset-block-start: 1.6rem;
    z-index: 10;
    justify-self: center;
    grid-column: 2;
    display: flex;
    justify-content: center;
    background: var(--surface-elevated);
    view-transition-name: nav-background;
    -webkit-backdrop-filter: blur(4px);
    backdrop-filter: blur(4px);
    border-radius: 1e5px;
    padding: var(--space-1);
    box-shadow: var(--shadow-ui);

    ul {
      display: flex;
      gap: 0.3ch;
      list-style-type: "";
      line-height: 1.25;
    }
  }

  .main-header {
    view-transition-name: --main-header;
    anchor-name: --header;
    position: relative;
    display: grid;
    grid: auto/minmax(var(--space-5), 1fr) minmax(auto, 1200px) minmax(
        var(--space-5),
        1fr
      );
    gap: var(--space-5) 0;
    padding-block: 1.5rlh;
    margin-block-end: 2.5rlh;
    background: var(--ui-surface);
    z-index: 100;

    &::before {
      content: "";
      position: absolute;
      bottom: 0;
      inset-inline-start: 0;
      inset-inline-end: 0;
      block-size: 1px;
      background: linear-gradient(
        90deg,
        var(--gray-300),
        var(--gray-300) 50%,
        transparent 0,
        transparent
      );
      background-size: 8px 1px;
    }

    .header-content {
      display: grid;
      grid: auto / 1fr auto 1fr;
      align-items: center;
      anchor-name: --header-content;

      &::before,
      &::after {
        --border-color: var(--gray-200);
        content: "";
        position: fixed;
        top: 0;
        bottom: anchor(--footer top);
        position-anchor: --header-content;
        inline-size: 1px;
        background: var(--border-color);
      }
      &::before {
        left: calc(anchor(left) - 1px - 1rem);
      }
      &::after {
        left: calc(anchor(right) + 1rem + 1px);
      }
    }

    .utils {
      grid-column-end: -1;
      display: flex;
      gap: 1ch;
      flex-flow: wrap;
      justify-content: flex-end;
    }

    & > * {
      grid-column: 2;
    }
  }
</style>
