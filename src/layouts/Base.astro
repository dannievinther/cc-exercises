---
import "/src/style/global.css";
import Head from "../components/Head.astro";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";

const { title, hasWarning, theme } = Astro.props;

const links = {
  Flexbox: {
    link: "/subgrid",
    label: "CSS Subgrid",
  },
  Grid: {
    link: "/flex",
    label: "CSS Flexbox",
  },
  Subgrid: {
    link: "/grid",
    label: "CSS Grid",
  },
  Defensive: {
    link: "/grid",
    label: "CSS Grid",
  },
  Sda: {
    link: "/grid",
    label: "CSS Grid",
  },
};
const label = links[title]?.label || "CSS Grid";
const link = links[title]?.link || "/grid";
---

<html lang="da" data-theme={theme}>
  <head>
    <Head title={title} />
    <style is:inline>
      @layer reset, prism, custom, tokens, components;
    </style>
  </head>
  <body>
    <Header {hasWarning} {title} />

    <main>
      <slot />
    </main>

    <Footer label={label} linkTo={link} />
    <script is:inline src="/script/bliss-minimal.js"></script>
    <script is:inline src="/script/prism.js"></script>
    <script is:inline src="/script/prism-linenumbers.js"></script>
    <script>
      // Lazy load Prism editor extensions on first textarea interaction
      let prismLoaded = false;

      async function loadPrismExtensions() {
        if (prismLoaded) return;
        prismLoaded = true;

        // Load prism-live.js first and wait for it to complete
        await new Promise((resolve, reject) => {
          const script = document.createElement("script");
          script.src = "/script/prism-live.js";
          script.onload = resolve;
          script.onerror = reject;
          document.body.appendChild(script);
        });

        // Then load the dependent scripts
        const dependentScripts = [
          "/script/prism-live-markup.js",
          "/script/prism-live-css.js",
        ];

        dependentScripts.forEach((src) => {
          const script = document.createElement("script");
          script.src = src;
          document.body.appendChild(script);
        });
      }

      // Load on first focus of any textarea
      document.addEventListener(
        "focusin",
        (e) => {
          if (
            e.target instanceof HTMLTextAreaElement &&
            e.target.classList.contains("prism-live")
          ) {
            loadPrismExtensions();
          }
        },
        { once: true }
      );

      // Preload scripts: use requestIdleCallback where supported,
      // setTimeout fallback for Safari
      if ("requestIdleCallback" in window) {
        requestIdleCallback(loadPrismExtensions, { timeout: 3000 });
      } else {
        // Safari fallback - load after short delay
        setTimeout(loadPrismExtensions, 100);
      }
    </script>
    <script>
      import "../js/exercises";
    </script>
    <style>
      [data-theme="green"] {
        --ui-primary: var(--green-100);
        --ui-primary-dark: var(--green-200);
        --ui-primary-border: var(--green-400);
      }

      [data-theme="purple"] {
        --ui-primary: var(--violet-100);
        --ui-primary-dark: var(--violet-200);
        --ui-primary-border: var(--violet-400);
      }

      [data-theme="indigo"] {
        --ui-primary: var(--indigo-100);
        --ui-primary-dark: var(--indigo-200);
        --ui-primary-border: var(--indigo-400);
      }

      [data-theme="periwinkle"] {
        --ui-primary: var(--periwinkle-100);
        --ui-primary-dark: var(--periwinkle-200);
        --ui-primary-border: var(--periwinkle-400);
      }

      [data-theme="pink"] {
        --ui-primary: var(--pink-100);
        --ui-primary-dark: var(--pink-200);
        --ui-primary-border: var(--pink-400);
      }
      body {
        position: relative;
        --grid: 35;
        --bg: hsl(209deg 15% 97%);
        --pct: 20%;
        --lines: hsl(209deg 27% 90%); /*var(--blue-muted-comment)*/
        background:
          linear-gradient(to bottom, var(--bg), 65%, rgba(255, 255, 255, 0)) 0 0 /
            100% 30vh no-repeat,
          linear-gradient(90deg, var(--bg), var(--pct), #fff0),
          linear-gradient(-90deg, var(--bg), var(--pct), #fff0),
          conic-gradient(from 90deg at 1px 1px, #0000 90deg, var(--lines) 0) 50%
            0 / calc((1200px - 2rem) / var(--grid)) calc(1200px / var(--grid)),
          var(--bg);

        &::before {
          z-index: -1;
          pointer-events: none;
          position: absolute;
          inset: 0;
          opacity: 0.15;
          content: "";
          background-image: url("/assets/svg/noise.svg");
          background-size: 500px;
        }
      }
    </style>
  </body>
</html>
