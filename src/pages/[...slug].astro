---
import { getCollection } from "astro:content";
import Exercises from "../components/Exercises.astro";
import SDAExercises from "../components/SDAExercises.astro";
import Base from "../layouts/Base.astro";
import ChevronLeftIcon from "../icons/chevron-left.svg";
import ChevronRightIcon from "../icons/chevron-right.svg";

export async function getStaticPaths() {
  // Vis drafts i dev-mode eller på staging branch (Vercel)
  const isStaging = process.env.VERCEL_GIT_COMMIT_REF === "staging";
  const showDrafts = import.meta.env.DEV || isStaging;

  const [grid, flexbox, subgrid, defensive, sda] = await Promise.all([
    getCollection("grid"),
    getCollection("flexbox"),
    getCollection("subgrid"),
    getCollection("defensive"),
    getCollection("sda"),
  ]);

  // Filter out drafts unless in dev mode or on staging
  const filterDrafts = <T extends { data: { draft?: boolean } }>(
    entries: T[]
  ): T[] => entries.filter((entry) => showDrafts || !entry.data.draft);

  const filteredGrid = filterDrafts(grid);
  const filteredFlexbox = filterDrafts(flexbox);
  const filteredSubgrid = filterDrafts(subgrid);
  const filteredDefensive = filterDrafts(defensive);
  const filteredSda = filterDrafts(sda);

  const allCollections = [
    ...filteredGrid,
    ...filteredFlexbox,
    ...filteredSubgrid,
    ...filteredDefensive,
    ...filteredSda,
  ];

  return allCollections.map((entry, index) => ({
    params: { slug: slug(entry) },
    // params: { id: entry.id },
    props: {
      entry,
      index: getIndex(entry, index),
      total: getTotal(entry),
      theme: getTheme(entry.collection),
      slugs: getCollectionSlugs(entry.collection),
    },
  }));

  function getCollectionSlugs(collection) {
    return allCollections
      .filter((item) => item.collection === collection)
      .map((item) => item.id);
  }

  function getIndex(entry, index) {
    const collection = entry.collection;
    const collectionEntries = allCollections.filter(
      (item) => item.collection === collection
    );
    const sortedEntries = collectionEntries.sort((a, b) =>
      a.id.localeCompare(b.id, undefined, { numeric: true })
    );
    const entryIndex = sortedEntries.findIndex((item) => item.id === entry.id);
    return entryIndex + 1;
  }

  function getTotal(entry) {
    const collection = entry.collection;
    const collectionMap = {
      grid: filteredGrid.length,
      flexbox: filteredFlexbox.length,
      subgrid: filteredSubgrid.length,
      defensive: filteredDefensive.length,
      sda: filteredSda.length,
    };

    return collectionMap[collection] || 0;
  }

  function getTheme(collection) {
    const themeMap = {
      grid: "green",
      flexbox: "purple",
      subgrid: "indigo",
      defensive: "green",
      sda: "indigo",
    };

    return themeMap[collection];
  }

  function slug(entry) {
    if (entry.collection === "flexbox") {
      return `flex/${entry.id.replace(/^0+/, "")}`;
    } else {
      return `${entry.collection}/${entry.id.replace(/^0+/, "")}`;
    }
  }
}

const { slug } = Astro.params;
const { entry, total, index, theme, slugs } = Astro.props;
const title =
  entry.collection.charAt(0).toUpperCase() + entry.collection.slice(1);
const sortedSlugs = slugs.sort((a, b) =>
  a.localeCompare(b, undefined, { numeric: true })
);

// Use SDA-specific component for scroll-driven animations
const ExerciseComponent = entry.collection === "sda" ? SDAExercises : Exercises;
// Render a link to the next exercise based on the current index of the slugs array
const nextLink = (entry: { id: string }, total: number) => {
  const currentIndex = sortedSlugs.indexOf(entry.id);
  const nextIndex = currentIndex + 1;

  if (nextIndex < total) {
    return sortedSlugs[nextIndex].replace(/^0+/, "");
  } else {
    return "/";
  }
};
const prevLink = (entry) => {
  const currentIndex = slugs.indexOf(entry.id);
  const prevIndex = currentIndex - 1;
  if (prevIndex >= 0) {
    return slugs[prevIndex].replace(/^0+/, "");
  } else {
    return null;
  }
};
---

<Base title={title} theme={theme}>
  <ExerciseComponent {entry} index={index} total={total} />
  <div class="navigation">
    {
      prevLink(entry) && (
        <a href={prevLink(entry)} class="prev">
          <ChevronLeftIcon stroke-width={3} width={16} height={16} />
          <span>Forrige</span>
        </a>
      )
    }
    {
      index < total && (
        <a href={nextLink(entry, total)} class="next">
          <span>Næste</span>
          <ChevronRightIcon stroke-width={3} width={16} height={16} />
        </a>
      )
    }
  </div>
</Base>

<style>
  .navigation {
    grid-column: 2;
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    justify-self: center;
    a {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: var(--space-4) var(--space-6);
      color: var(--blue-900);
      border-radius: var(--bdrs-md);
      transition: 0.1s linear;
      text-decoration: none;
      text-transform: uppercase;
      font-variation-settings: "wdth" 120;
      font-family: var(--font-mona);
      font-size: 0.75rem;
      font-weight: 700;
      letter-spacing: 0.075em;

      box-shadow:
        #fff 0 0,
        #3341551a 0 0 0 1px,
        #0000000d 0 20px 25px -5px,
        #0000000d 0 8px 10px -6px;
      background:
        linear-gradient(#fff, #f3f4f6) 0% 100% / 100% 2rem no-repeat padding-box,
        #fff;
      border: 1px solid transparent;

      color: unset;
      background: var(--surface-elevated);
      border-radius: 1e5px;
      corner-shape: squircle;
      padding: var(--space-4) var(--space-5);
      box-shadow: var(--shadow-ui);
      cursor: pointer;

      &.prev {
        --offset: 0.2rem;
        padding-inline-start: var(--space-4);
      }
      &.next {
        --offset: -0.2rem;
        padding-inline-end: var(--space-4);
      }

      [data-icon] {
        color: var(--chevron-color, var(--blue-muted));
        translate: var(--_offset, var(--offset)) -1px;
        transition: 0.2s;
      }

      &:hover {
        --_offset: 0;
        --chevron-color: var(--gray-1000);
        border-color: var(--blue-700);
      }
    }
  }
</style>
